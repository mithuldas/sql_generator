SELECT /* +RULE*/  distinct A.STAFF_NUM as STAFF_N,  A.PREFERRED_NAME ,A.FIRST_NAME, A.SURNAME, B.RANK_CD, C.BASE ,AGG_FLEETS."Active Fleets", co.contract_cd
FROM   CREW_RANK_V B,CREW_BASE_V C , CREW_RSRC_GRP_V P,  CREW_V A, CREW_CONTRACTS_V CO, (SELECT STAFF_NUM,
       LISTAGG(FLEET_CD , ',')  WITHIN GROUP (ORDER BY fleet_cd ) as "Active Fleets"
  FROM crew_fleet_v where eff_dt<=TO_DATE('201503010000','YYYYMMDDHH24MI') and (exp_dt is null or exp_dt>TO_DATE('201503010000','YYYYMMDDHH24MI'))
  GROUP BY STAFF_NUM) agg_fleets
WHERE A.staff_num=agg_fleets.staff_num and a.staff_num=co.staff_num and A.STAFF_NUM = B.STAFF_NUM  AND A.STAFF_NUM = C.STAFF_NUM  AND A.STAFF_NUM = P.STAFF_NUM  
AND (A.TERM_DT >= TO_DATE('201503010000','YYYYMMDDHH24MI') OR A.TERM_DT IS NULL )  AND (A.RETR_DT >= TO_DATE('201503010000','YYYYMMDDHH24MI') OR A.RETR_DT IS NULL )  
AND ((TO_DATE('201503010000','YYYYMMDDHH24MI') < B.EXP_DT OR B.EXP_DT is NULL) AND TO_DATE('201503312359','YYYYMMDDHH24MI') > B.EFF_DT)  
AND ((TO_DATE('201503010000','YYYYMMDDHH24MI') < C.EXP_DT OR C.EXP_DT is NULL) AND TO_DATE('201503312359','YYYYMMDDHH24MI') > C.EFF_DT)  
AND ((TO_DATE('201503010000','YYYYMMDDHH24MI') < CO.EXP_DT OR CO.EXP_DT is NULL) AND TO_DATE('201503312359','YYYYMMDDHH24MI') > CO.EFF_DT)
AND A.STAFF_NUM IN  (  SELECT STAFF_NUM FROM CREW_FLEET_V  WHERE VALID_IND = 'Y' AND  FLEET_CD IN ('320','330','767','IL9','SU9','M1F','777','737') AND  ( (TO_DATE('201503010000','YYYYMMDDHH24MI') BETWEEN EFF_DT AND NVL(EXP_DT,TO_DATE('31-DEC-2999','DD-MON-YYYY'))) OR  (TO_DATE('201503312359','YYYYMMDDHH24MI') BETWEEN EFF_DT AND NVL(EXP_DT,TO_DATE('31-DEC-2999','DD-MON-YYYY'))) )  GROUP BY STAFF_NUM  )  AND (C.BASE IN ('KRR','VVO','KHV','LED','SVO','OVB','CEK','OMS','SVX','IKT','KJA','KGD','BAX','EVN','MRV')  AND C.PRIM_BASE = 'Y')  AND B.RANK_CD IN ('CPT','FO','ENG','NVG','FDT','PA','GM','BCA','EC','CDT','CTN','CIN')  AND ((TO_DATE('201503010000','YYYYMMDDHH24MI') < P.EXP_DT OR P.EXP_DT is NULL) AND TO_DATE('201503312359','YYYYMMDDHH24MI') > P.EFF_DT)
order by a.staff_num;

-- new, master crew list

select A.STAFF_NUM as "Staff Number",  A.PREFERRED_NAME as "Preferred Name",A.FIRST_NAME as "First Name", A.SURNAME, E.EMPL_STATUS_CD "Status", P.RSRC_GRP_CD "Resource Group", B.RANK_CD as "Rank", C.BASE ,AGG_FLEETS."Active Fleets", co.contract_cd as "Contract" from crew_v a 
left join crew_rank_v b on a.staff_num=b.staff_num and ((TO_DATE('201503010000','YYYYMMDDHH24MI') < B.EXP_DT OR B.EXP_DT is NULL) AND TO_DATE('201503312359','YYYYMMDDHH24MI') > B.EFF_DT)
left join crew_contracts_v co on a.staff_num=co.staff_num AND ((TO_DATE('201503010000','YYYYMMDDHH24MI') < CO.EXP_DT OR CO.EXP_DT is NULL) AND TO_DATE('201503312359','YYYYMMDDHH24MI') > CO.EFF_DT)
left join crew_base_v c on a.staff_num=c.staff_num and ((TO_DATE('201503010000','YYYYMMDDHH24MI') < C.EXP_DT OR C.EXP_DT is NULL) AND TO_DATE('201503312359','YYYYMMDDHH24MI') > C.EFF_DT) and prim_base='Y'  
left join crew_rsrc_grp_v p on a.staff_num=p.staff_num AND ((TO_DATE('201503010000','YYYYMMDDHH24MI') < P.EXP_DT OR P.EXP_DT is NULL) AND TO_DATE('201503312359','YYYYMMDDHH24MI') > P.EFF_DT)
left join (SELECT STAFF_NUM, LISTAGG(FLEET_CD , ',')  WITHIN GROUP (ORDER BY fleet_cd ) as "Active Fleets" FROM crew_fleet_v where eff_dt<=TO_DATE('201503010000','YYYYMMDDHH24MI') and (exp_dt is null or exp_dt>TO_DATE('201503010000','YYYYMMDDHH24MI')) GROUP BY STAFF_NUM) agg_fleets on a.staff_num=agg_fleets.staff_num
left join crew_employment_status_v e on a.staff_num=e.staff_num and ((TO_DATE('201503010000','YYYYMMDDHH24MI') < E.EXP_DT OR E.EXP_DT is NULL) AND TO_DATE('201503312359','YYYYMMDDHH24MI') > E.EFF_DT) order by A.STAFF_NUM;