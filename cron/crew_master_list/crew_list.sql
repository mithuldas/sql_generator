select A.STAFF_NUM as "Staff Number",  A.PREFERRED_NAME as "Preferred Name",A.FIRST_NAME as "First Name", A.SURNAME, E.EMPL_STATUS_CD "Status", P.RSRC_GRP_CD "Resource Group", B.RANK_CD as "Rank", C.BASE ,AGG_FLEETS."Active Fleets", co.contract_cd as "Contract" from crew_v a 
left join crew_rank_v b on a.staff_num=b.staff_num and ((TO_DATE(to_char(trunc(add_months(sysdate,0), 'MON'),'YYYYMMDDHH24MI'),'YYYYMMDDHH24MI') < B.EXP_DT OR B.EXP_DT is NULL) AND TO_DATE(to_char(trunc(last_day(add_months(sysdate,0)),'DD'),'YYYYMMDD')||'2359','YYYYMMDDHH24MI') > B.EFF_DT)
left join crew_contracts_v co on a.staff_num=co.staff_num AND ((TO_DATE(to_char(trunc(add_months(sysdate,0), 'MON'),'YYYYMMDDHH24MI'),'YYYYMMDDHH24MI') < CO.EXP_DT OR CO.EXP_DT is NULL) AND TO_DATE(to_char(trunc(last_day(add_months(sysdate,0)),'DD'),'YYYYMMDD')||'2359','YYYYMMDDHH24MI') > CO.EFF_DT)
left join crew_base_v c on a.staff_num=c.staff_num and ((TO_DATE(to_char(trunc(add_months(sysdate,0), 'MON'),'YYYYMMDDHH24MI'),'YYYYMMDDHH24MI') < C.EXP_DT OR C.EXP_DT is NULL) AND TO_DATE(to_char(trunc(last_day(add_months(sysdate,0)),'DD'),'YYYYMMDD')||'2359','YYYYMMDDHH24MI') > C.EFF_DT) and prim_base='Y'  
left join crew_rsrc_grp_v p on a.staff_num=p.staff_num AND ((TO_DATE(to_char(trunc(add_months(sysdate,0), 'MON'),'YYYYMMDDHH24MI'),'YYYYMMDDHH24MI') < P.EXP_DT OR P.EXP_DT is NULL) AND TO_DATE(to_char(trunc(last_day(add_months(sysdate,0)),'DD'),'YYYYMMDD')||'2359','YYYYMMDDHH24MI') > P.EFF_DT)
left join (SELECT STAFF_NUM, LISTAGG(FLEET_CD , ',')  WITHIN GROUP (ORDER BY fleet_cd ) as "Active Fleets" FROM crew_fleet_v where eff_dt<=TO_DATE(to_char(trunc(add_months(sysdate,0), 'MON'),'YYYYMMDDHH24MI'),'YYYYMMDDHH24MI') and (exp_dt is null or exp_dt>TO_DATE(to_char(trunc(add_months(sysdate,0), 'MON'),'YYYYMMDDHH24MI'),'YYYYMMDDHH24MI')) GROUP BY STAFF_NUM) agg_fleets on a.staff_num=agg_fleets.staff_num
left join crew_employment_status_v e on a.staff_num=e.staff_num and ((TO_DATE(to_char(trunc(add_months(sysdate,0), 'MON'),'YYYYMMDDHH24MI'),'YYYYMMDDHH24MI') < E.EXP_DT OR E.EXP_DT is NULL) AND TO_DATE(to_char(trunc(last_day(add_months(sysdate,0)),'DD'),'YYYYMMDD')||'2359','YYYYMMDDHH24MI') > E.EFF_DT) order by A.STAFF_NUM;